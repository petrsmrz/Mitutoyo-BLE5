
<html>
  <body>
    <h1>Sylvac S_Cal EVO caliper IP67</h1>
    <h2>
    <p id="demo"></p>
    </h2>
<button onclick="connectBT()">Click me</button>
<p>
<button onclick="onBatteryButtonClick()">Click me for Battery Demo</button>
<p> 


<script>
  console.log("ttt6b");
document.getElementById("demo").innerHTML = "Hello JavaScript!";
</script> 
    
    <script>
          log = console.log;
          async function onBatteryButtonClick() {
            try {
              log('Requesting Bluetooth Device...');
              const device = await navigator.bluetooth.requestDevice({
                  filters: [{services: ['battery_service']}] });

              log('Connecting to GATT Server...');
              const server = await device.gatt.connect();

              log('Getting Battery Service...');
              const service = await server.getPrimaryService('battery_service');

              log('Getting Battery Level Characteristic...');
              const characteristic = await service.getCharacteristic('battery_level');

              log('Reading Battery Level...');
              const value = await characteristic.readValue();

              log('> Battery Level is ' + value.getUint8(0) + '%');
            } catch(error) {
              log('Argh! ' + error);
            }
          }

          async function connectBT() {
            try {
              log("requesting caliper device");
              //const device = await navigator.bluetooth.requestDevice({filters: [{ services: ['c1b25000-caaf-6d0e-4c33-7dae30052840'] }] });
              const device = await navigator.bluetooth.requestDevice( {acceptAllDevices: true,  optionalServices: ['c1b25000-caaf-6d0e-4c33-7dae30052840']} );
              log("got device " + device.name);
              log('Connecting to GATT Server...');
              const server = await device.gatt.connect();

              log('Getting caliper Service...');
              const service = await server.getPrimaryService('c1b25000-caaf-6d0e-4c33-7dae30052840');
              log(service);

              const notif_characteristics = await service.getCharacteristic("c1b25013-caaf-6d0e-4c33-7dae30052840");
              log("notif char", notif_characteristics); 
              await notif_characteristics.startNotifications();
              log("notifications started")
              notif_characteristics.addEventListener('characteristicvaluechanged', handleNotif);
              
              const characteristic = await service.getCharacteristic("c1b25012-caaf-6d0e-4c33-7dae30052840");
              var enc = new TextEncoder("utf-8");
              characteristic.writeValue(enc.encode("?\r"));
              window.btch = characteristic;

              // setInterval(function(){ 
              //   console.log("tick"); 
              //   characteristic.writeValue(enc.encode("?\r")); 
              // }, 1000);

            } catch(error) {
              log('Argh! ' + error);
            }
          }
      function connectBT_old() {
        console.log("testik");
        navigator.bluetooth.requestDevice({acceptAllDevices: true,  optionalServices: ['c1b25000-caaf-6d0e-4c33-7dae30052840']})
          .then(device => {
          // Human-readable name of the device.
          console.log(device.name);

          // Attempts to connect to remote GATT Server.
          return device.gatt.connect();
          })
          .then(server => { console.log("server ", server); 
            return server.getPrimaryService("c1b25000-caaf-6d0e-4c33-7dae30052840");})
          .then(service => {
            console.log("service ", service); 

            service.getCharacteristic("c1b25013-caaf-6d0e-4c33-7dae30052840")
              .then(ch =>{ console.log("notif char", ch); 
                    ch.startNotifications();
                    ch.addEventListener('characteristicvaluechanged',
                                  handleNotif); });
            // Getting Battery Level Characteristic...
            return service.getCharacteristic("c1b25012-caaf-6d0e-4c33-7dae30052840");
          })
          .then(characteristic => {
       
            console.log("characteristic ", characteristic); 
            var enc = new TextEncoder("utf-8");
            console.log(enc.encode("This is a string converted to a Uint8Array"));

            setInterval(function(){ console.log("tick"); 
            console.log("char", characteristic);
            //characteristic.writeValue(enc.encode("?\r")); 
            characteristic.writeValue(enc.encode("?\r")); 
            }
            , 1000);

            return characteristic.writeValue(enc.encode("?\r"));
          })
          .catch(error => { console.log(error); });

      }
      function handleNotif(event) {
        console.log("notified");
        console.log(event);
        let value = event.target.value;
        let a = [];
        // Convert raw data bytes to hex values just for the sake of showing something.
        // In the "real" world, you'd use data.getUint8, data.getUint16 or even
        // TextDecoder to process raw data bytes.
        for (let i = 0; i < value.byteLength; i++) {
          a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
        }
        console.log('> ' + a.join(' '));
        var decoder = new TextDecoder("utf-8");
        var decodedString = decoder.decode(value);
        console.log(decodedString);
        document.getElementById("demo").innerHTML = decodedString;
      }
    </script>
  </body>
 </html>
