
<html>
  <head>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  </head>
  <body>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>



    <h1>Sylvac S_Cal EVO caliper IP67</h1>
    <h2>
    <p id="demo"></p>
    </h2>
    <h2>
      <p id="demo2"></p>
      </h2>
<button onclick="connectBTNew()">Click me</button>
<button onclick="addNewRow();">Add row</button>
<button onclick="addNewData('somedata');">Add some data</button>
<p>
<button onclick="onBatteryButtonClick()">Click me for Battery Demo</button>
<p> 
 




  <table class="table" id="table">
    <tr id="datarow"></tr>
  </table>

  <hr>
  <pre id="log">7a</pre>


<script>

document.getElementById("demo").innerHTML = "Hello JavnnnaScript!";
</script> 
    
    <script>
          //log = console.log;
          function log(a) {
            document.getElementById("log").innerHTML += "\n"+a;
          }
          async function onBatteryButtonClick() {
            try {
              log('Requesting Bluetooth Device...');
              const device = await navigator.bluetooth.requestDevice({
                  filters: [{services: ['battery_service']}] });

              log('Connecting to GATT Server...');
              const server = await device.gatt.connect();

              log('Getting Battery Service...');
              const service = await server.getPrimaryService('battery_service');

              log('Getting Battery Level Characteristic...');
              const characteristic = await service.getCharacteristic('battery_level');

              log('Reading Battery Level...');
              const value = await characteristic.readValue();

              log('> Battery Level is ' + value.getUint8(0) + '%');
            } catch(error) {
              log('Argh! ' + error);
            }
          }

          async function connectBTNew() {
            try {
              log("requesting caliper device");
              //const device = await navigator.bluetooth.requestDevice({filters: [{ services: ['c1b25000-caaf-6d0e-4c33-7dae30052840'] }] });
              const device = await navigator.bluetooth.requestDevice( {acceptAllDevices: true,  optionalServices: ['c1b25000-caaf-6d0e-4c33-7dae30052840']} );
              log("got device " + device.name);
              log('Connecting to GATT Server...');
              const server = await device.gatt.connect();

              log('Getting caliper Service...');
              const service = await server.getPrimaryService('c1b25000-caaf-6d0e-4c33-7dae30052840');
              log(service);

              const notif_characteristics = await service.getCharacteristic("c1b25013-caaf-6d0e-4c33-7dae30052840");
              log("notif char", notif_characteristics); 
              await notif_characteristics.startNotifications();
              log("notifications started")
              notif_characteristics.addEventListener('characteristicvaluechanged', handleNotif);

              const indic_characteristics = await service.getCharacteristic("c1b25010-caaf-6d0e-4c33-7dae30052840");
              log("indic_characteristics", indic_characteristics); 
              await indic_characteristics.startNotifications();
              log("indic_characteristics notification started")
              indic_characteristics.addEventListener('characteristicvaluechanged', handleInd);


              const characteristic = await service.getCharacteristic("c1b25012-caaf-6d0e-4c33-7dae30052840");
              var enc = new TextEncoder("utf-8");
              characteristic.writeValue(enc.encode("?\r"));
              window.btch = characteristic;

              // setInterval(function(){ 
              //   console.log("tick"); 
              //   characteristic.writeValue(enc.encode("?\r")); 
              // }, 1000);

            } catch(error) {
              log('Argh! ' + error);
            }
          }
      function connectBT_old() {
        console.log("testik");
        navigator.bluetooth.requestDevice({acceptAllDevices: true,  optionalServices: ['c1b25000-caaf-6d0e-4c33-7dae30052840']})
          .then(device => {
          // Human-readable name of the device.
          console.log(device.name);

          // Attempts to connect to remote GATT Server.
          return device.gatt.connect();
          })
          .then(server => { console.log("server ", server); 
            return server.getPrimaryService("c1b25000-caaf-6d0e-4c33-7dae30052840");})
          .then(service => {
            console.log("service ", service); 

            service.getCharacteristic("c1b25013-caaf-6d0e-4c33-7dae30052840")
              .then(ch =>{ console.log("notif char", ch); 
                    ch.startNotifications();
                    ch.addEventListener('characteristicvaluechanged',
                                  handleNotif); });
            // Getting Battery Level Characteristic...
            return service.getCharacteristic("c1b25012-caaf-6d0e-4c33-7dae30052840");
          })
          .then(characteristic => {
       
            console.log("characteristic ", characteristic); 
            var enc = new TextEncoder("utf-8");
            console.log(enc.encode("This is a string converted to a Uint8Array"));

            setInterval(function(){ console.log("tick"); 
            console.log("char", characteristic);
            //characteristic.writeValue(enc.encode("?\r")); 
            characteristic.writeValue(enc.encode("?\r")); 
            }
            , 1000);

            return characteristic.writeValue(enc.encode("?\r"));
          })
          .catch(error => { console.log(error); });

      }
      function handleNotif(event) {
        console.log("notified");
        console.log(event);
        let value = event.target.value;
        let a = [];
        // Convert raw data bytes to hex values just for the sake of showing something.
        // In the "real" world, you'd use data.getUint8, data.getUint16 or even
        // TextDecoder to process raw data bytes.
        for (let i = 0; i < value.byteLength; i++) {
          a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
        }
        console.log('> ' + a.join(' '));
        var decoder = new TextDecoder("utf-8");
        var decodedString = decoder.decode(value);
        console.log(decodedString);
        document.getElementById("demo").innerHTML = decodedString;
      }
      function addNewRow() {
        document.getElementById('datarow')
          .insertAdjacentHTML('afterend', '<tr id="newrow"></row>');
        datarow = document.getElementById("datarow");
        newrow = document.getElementById("newrow");
        datarow.removeAttribute('id');
        newrow.setAttribute("id", "datarow");
      }
      function addNewData(datastr) {
        document.getElementById("datarow").innerHTML += "<td>"+datastr+"</td>";
      }

      function handleInd(event) {
        
        let value = event.target.value;
        
        var decoder = new TextDecoder("utf-8");
        var decodedString = decoder.decode(value);
        log(decodedString);
        
        log("deciding on "+ JSON.stringify(parseInt(decodedString.substring(1) )) );
        log("deciding on "+ JSON.stringify(parseInt(decodedString.substring(1) )>=70) );
        if (parseInt(decodedString.substring(1) )>=70) {
          addNewRow(); 
          return;
        }


        document.getElementById("datarow").innerHTML += "<td>"+decodedString+"</td>";
  
      }  

      function handleInd_old(event) {
        log("handleInd");
        log(JSON.stringify(event));
        let value = event.target.value;
        let a = [];
        // Convert raw data bytes to hex values just for the sake of showing something.
        // In the "real" world, you'd use data.getUint8, data.getUint16 or even
        // TextDecoder to process raw data bytes.
        for (let i = 0; i < value.byteLength; i++) {
          a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
        }
        console.log('> ' + a.join(' '));

        var decoder = new TextDecoder("utf-8");
        var decodedString = decoder.decode(value);
        log(decodedString);
        document.getElementById("demo2").innerHTML = decodedString;
      }
    </script>
  </body>
 </html>
